stages:
  - build
  - deploy

build_job:
  stage: build
  image: ruby:2.7
  before_script:
    - gem install bundler
    - bundle install --jobs "$(nproc)" --retry 3
  script:
    - bundle exec rake assets:precompile
  artifacts:
    paths:
      - public/assets/

deploy_job:
  stage: deploy
  image: ruby:2.7
  before_script:
    - apt-get update && apt-get install -y openssh-client
  script:
    - echo "$EC2_PEM_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa "$SSH_USER"@"$EC2_PUBLIC_IP" "cd /var/www/my_app && git pull"

